console.log('üöÄ VitexAI iniciando...');

// Vari√°veis globais
let supabase = null;
let currentUser = null;
let transactions = [];
let categories = {
    receita: ['Consultoria', 'Desenvolvimento', 'Licenciamento', 'Outras'],
    despesa: ['Pr√≥-labore', 'Impostos', 'Terceiros', 'Desenvolvedores', 'Assinaturas', 'Marketing', 'Outras']
};
let charts = {};
let demoMode = false;
let lastTransactionTime = 0;
let updateDashboardTimeout = null;
let chatOpen = false;

// Internationalization System
let currentLanguage = localStorage.getItem('vitexai_language') || 'en';

const translations = {
    en: {
        // Headers
        'header.subtitle': 'Financial Intelligence Dashboard',
        'header.mainSubtitle': 'Financial Intelligence & Analytics',
        
        // Navigation
        'nav.transactions': 'Transactions',
        'nav.dashboard': 'Dashboard',
        'nav.trends': 'Trends',
        'nav.projections': 'Projections',
        'nav.analytics': 'Analytics',
        'nav.reports': 'Reports',
        'nav.settings': 'Settings',
        'nav.signout': 'Sign Out',
        
        // Auth
        'auth.welcome': 'Welcome to VitexAI',
        'auth.signin': 'Sign In',
        'auth.signup': 'Sign Up',
        'auth.email': 'Email',
        'auth.password': 'Password',
        'auth.fullName': 'Full Name',
        'auth.confirmPassword': 'Confirm Password',
        'auth.forgotPassword': 'Forgot Password?',
        'auth.createAccount': 'Create Account',
        
        // Setup
        'setup.title': 'Initial Setup',
        'setup.description': 'Configure your database connection:',
        'setup.tip': 'Tip:',
        'setup.tipText': 'If you haven\'t created the table in Supabase yet, use the SIMPLE structure (without user_id) available in Settings after login.',
        'setup.configure': 'Configure Connection',
        'setup.demoMode': 'Try Demo Mode',
        
        // Transactions
        'transactions.quickEntry': 'Quick Transaction Entry',
        'transactions.date': 'Date',
        'transactions.type': 'Type',
        'transactions.revenue': 'Revenue',
        'transactions.expense': 'Expense',
        'transactions.category': 'Category',
        'transactions.amount': 'Amount (R$)',
        'transactions.description': 'Description',
        'transactions.add': 'Add Transaction',
        'transactions.history': 'Transaction History',
        'transactions.sync': 'Sync Data',
        'transactions.loadSample': 'Load Sample Data',
        
        // Table
        'table.date': 'Date',
        'table.type': 'Type',
        'table.category': 'Category',
        'table.description': 'Description',
        'table.amount': 'Amount',
        'table.actions': 'Actions',
        'table.month': 'Month',
        'table.revenue': 'Revenue',
        'table.expenses': 'Expenses',
        'table.result': 'Result',
        'table.momGrowth': 'MoM Growth',
        'table.margin': 'Margin',
        'table.status': 'Status',
        
        // Metrics
        'metrics.totalRevenue': 'Total Revenue',
        'metrics.totalExpenses': 'Total Expenses',
        'metrics.netResult': 'Net Result',
        'metrics.averageMargin': 'Average Margin',
        'metrics.monthlyRevenueAvg': 'Monthly Revenue Avg',
        'metrics.averageBurnRate': 'Average Burn Rate',
        'metrics.cumulativeROI': 'Cumulative ROI',
        'metrics.taxBurden': 'Tax Burden',
        'metrics.fixedCosts': 'Fixed Costs %',
        'metrics.revenueExpenseRatio': 'Revenue/Expense Ratio',
        'metrics.taxesRevenue': 'Taxes/Revenue',
        'metrics.salariesSubscriptions': 'Salaries + Subscriptions',
        
        // Dashboard
        'dashboard.overallPerformance': 'Overall Performance Metrics',
        'dashboard.revenueMix': 'Revenue Mix Analysis',
        'dashboard.operationalEfficiency': 'Operational Efficiency',
        
        // Categories
        'categories.consulting': 'Consulting',
        'categories.development': 'Development',
        'categories.otherRevenue': 'Other Revenue',
        
        // Trends
        'trends.analysis': 'Trend Analysis',
        'trends.avgMoMGrowth': 'Average MoM Growth',
        'trends.monthlyRevenue': 'Monthly revenue',
        'trends.revenueVolatility': 'Revenue Volatility',
        'trends.coefficientVariation': 'Coefficient of variation',
        'trends.positiveMonths': 'Positive Months',
        'trends.bestResult': 'Best Result',
        'trends.monthlyEvolution': 'Monthly Evolution',
        'trends.monthlyDetailed': 'Monthly Detailed Analysis',
        
        // Projections
        'projections.title': 'Projections & Goals',
        'projections.projectedRevenue': 'Projected Revenue (Next Month)',
        'projections.basedOnAverage': 'Based on moving average',
        'projections.monthlyBreakeven': 'Monthly Break-even',
        'projections.avgMonthlyExpenses': 'Average monthly expenses',
        'projections.runway': 'Runway (Months)',
        'projections.withAvgResult': 'With average result',
        'projections.targetMargin': 'Target Margin',
        'projections.recommendedTarget': 'Recommended target',
        'projections.scenarioSimulator': 'Scenario Simulator',
        'projections.monthlyRevenueTarget': 'Monthly Revenue Target (R$)',
        'projections.expenseIncrease': 'Expense Increase %',
        'projections.availableCash': 'Available Cash (R$)',
        'projections.calculate': 'Calculate Scenario',
        
        // Analytics
        'analytics.title': 'Analytics & Visualizations',
        'analytics.monthlyEvolution': 'Monthly Evolution - Revenue vs Expenses',
        'analytics.revenueDistribution': 'Revenue Distribution',
        'analytics.expenseDistribution': 'Expense Distribution',
        'analytics.marginEvolution': 'Margin Evolution (%)',
        
        // Reports
        'reports.title': 'Reports & Export',
        'reports.exportData': 'Export Data',
        'reports.exportCSV': 'Export to CSV',
        'reports.backupJSON': 'Backup to JSON',
        'reports.executiveReport': 'Executive Report',
        
        // Settings
        'settings.title': 'System Settings',
        'settings.userProfile': 'User Profile',
        'settings.authenticatedUser': 'Authenticated user',
        'settings.activeSession': 'Active session',
        'settings.transactionsRecorded': 'Transactions recorded',
        'settings.advanced': 'Advanced Settings',
        'settings.comingSoon': 'Coming soon: custom categories, automatic goals, bank integration.',
        'settings.databaseStructure': 'Database Structure',
        'settings.important': 'Important:',
        'settings.userIdError': 'If you\'re getting \'user_id\' errors, use the SIMPLE structure below:',
        'settings.simpleStructure': 'Option 1 - SIMPLE Structure (recommended to start):',
        'settings.completeStructure': 'Option 2 - COMPLETE Structure (with user isolation):',
        'settings.copySimple': 'Copy Simple Structure',
        'settings.copyComplete': 'Copy Complete Structure',
        
        // Chat
        'chat.askData': 'Ask the Data',
        'chat.title': 'VitexAI Assistant',
        'chat.welcome': 'Hi! I can help you analyze your financial data. Try asking:\n\n‚Ä¢ "What was my biggest expense this month?"\n‚Ä¢ "Show me revenue trends"\n‚Ä¢ "How is my margin evolving?"\n‚Ä¢ "What\'s my current financial health?"',
        'chat.send': 'Send',
        
        // Footer
        'footer.description': 'Financial Intelligence Dashboard',
        'footer.version': 'Version 3.0 | Advanced Analytics | Real-time Insights',
        
        // Executive Report
        'report.executiveTitle': 'Executive Financial Report',
        'report.prepared': 'Prepared for',
        'report.board': 'Board of Directors',
        'report.executiveSummary': 'Executive Summary',
        'report.keyMetrics': 'Key Performance Indicators',
        'report.trendAnalysis': 'Trend Analysis',
        'report.insights': 'Strategic Insights',
        'report.recommendations': 'Recommendations',
        'report.conclusion': 'Conclusion',
        'report.details': 'Detailed Analysis',
        'report.financialHealth': 'Financial Health Status',
        'report.growth': 'Growth',
        'report.stability': 'Stability',
        'report.decline': 'Decline',
        'report.critical': 'Critical',
        'report.currentPeriod': 'Current Period',
        'report.previousPeriod': 'Previous Period',
        'report.change': 'Change',
        'report.positiveGrowth': 'positive growth',
        'report.negativeGrowth': 'negative decline',
        'report.lastUpdated': 'Last Updated',
        'report.printReport': 'Print Report'
    },
    pt: {
        // Headers
        'header.subtitle': 'Painel de Intelig√™ncia Financeira',
        'header.mainSubtitle': 'Intelig√™ncia Financeira & An√°lises',
        
        // Navigation
        'nav.transactions': 'Lan√ßamentos',
        'nav.dashboard': 'Painel',
        'nav.trends': 'Tend√™ncias',
        'nav.projections': 'Proje√ß√µes',
        'nav.analytics': 'An√°lises',
        'nav.reports': 'Relat√≥rios',
        'nav.settings': 'Configura√ß√µes',
        'nav.signout': 'Sair',
        
        // Auth
        'auth.welcome': 'Bem-vindo ao VitexAI',
        'auth.signin': 'Entrar',
        'auth.signup': 'Cadastrar',
        'auth.email': 'Email',
        'auth.password': 'Senha',
        'auth.fullName': 'Nome Completo',
        'auth.confirmPassword': 'Confirmar Senha',
        'auth.forgotPassword': 'Esqueceu a senha?',
        'auth.createAccount': 'Criar Conta',
        
        // Setup
        'setup.title': 'Configura√ß√£o Inicial',
        'setup.description': 'Configure sua conex√£o com o banco de dados:',
        'setup.tip': 'Dica:',
        'setup.tipText': 'Se voc√™ ainda n√£o criou a tabela no Supabase, use a estrutura SIMPLES (sem user_id) dispon√≠vel em Configura√ß√µes ap√≥s o login.',
        'setup.configure': 'Configurar Conex√£o',
        'setup.demoMode': 'Experimentar Modo Demo',
        
        // Transactions
        'transactions.quickEntry': 'Entrada R√°pida de Transa√ß√£o',
        'transactions.date': 'Data',
        'transactions.type': 'Tipo',
        'transactions.revenue': 'Receita',
        'transactions.expense': 'Despesa',
        'transactions.category': 'Categoria',
        'transactions.amount': 'Valor (R$)',
        'transactions.description': 'Descri√ß√£o',
        'transactions.add': 'Adicionar Transa√ß√£o',
        'transactions.history': 'Hist√≥rico de Transa√ß√µes',
        'transactions.sync': 'Sincronizar Dados',
        'transactions.loadSample': 'Carregar Dados de Exemplo',
        
        // Table
        'table.date': 'Data',
        'table.type': 'Tipo',
        'table.category': 'Categoria',
        'table.description': 'Descri√ß√£o',
        'table.amount': 'Valor',
        'table.actions': 'A√ß√µes',
        'table.month': 'M√™s',
        'table.revenue': 'Receita',
        'table.expenses': 'Despesas',
        'table.result': 'Resultado',
        'table.momGrowth': 'Crescimento MoM',
        'table.margin': 'Margem',
        'table.status': 'Status',
        
        // Metrics
        'metrics.totalRevenue': 'Receita Total',
        'metrics.totalExpenses': 'Despesas Totais',
        'metrics.netResult': 'Resultado L√≠quido',
        'metrics.averageMargin': 'Margem M√©dia',
        'metrics.monthlyRevenueAvg': 'M√©dia de Receita Mensal',
        'metrics.averageBurnRate': 'Taxa de Queima M√©dia',
        'metrics.cumulativeROI': 'ROI Acumulado',
        'metrics.taxBurden': 'Carga Tribut√°ria',
        'metrics.fixedCosts': 'Custos Fixos %',
        'metrics.revenueExpenseRatio': 'Raz√£o Receita/Despesa',
        'metrics.taxesRevenue': 'Impostos/Receita',
        'metrics.salariesSubscriptions': 'Sal√°rios + Assinaturas',
        
        // Dashboard
        'dashboard.overallPerformance': 'M√©tricas de Desempenho Geral',
        'dashboard.revenueMix': 'An√°lise do Mix de Receitas',
        'dashboard.operationalEfficiency': 'Efici√™ncia Operacional',
        
        // Categories
        'categories.consulting': 'Consultoria',
        'categories.development': 'Desenvolvimento',
        'categories.otherRevenue': 'Outras Receitas',
        
        // Trends
        'trends.analysis': 'An√°lise de Tend√™ncias',
        'trends.avgMoMGrowth': 'Crescimento MoM M√©dio',
        'trends.monthlyRevenue': 'Receita mensal',
        'trends.revenueVolatility': 'Volatilidade da Receita',
        'trends.coefficientVariation': 'Coeficiente de varia√ß√£o',
        'trends.positiveMonths': 'Meses Positivos',
        'trends.bestResult': 'Melhor Resultado',
        'trends.monthlyEvolution': 'Evolu√ß√£o Mensal',
        'trends.monthlyDetailed': 'An√°lise Detalhada Mensal',
        
        // Projections
        'projections.title': 'Proje√ß√µes & Metas',
        'projections.projectedRevenue': 'Receita Projetada (Pr√≥ximo M√™s)',
        'projections.basedOnAverage': 'Baseado na m√©dia m√≥vel',
        'projections.monthlyBreakeven': 'Ponto de Equil√≠brio Mensal',
        'projections.avgMonthlyExpenses': 'Despesas mensais m√©dias',
        'projections.runway': 'Runway (Meses)',
        'projections.withAvgResult': 'Com resultado m√©dio',
        'projections.targetMargin': 'Margem Alvo',
        'projections.recommendedTarget': 'Meta recomendada',
        'projections.scenarioSimulator': 'Simulador de Cen√°rios',
        'projections.monthlyRevenueTarget': 'Meta de Receita Mensal (R$)',
        'projections.expenseIncrease': 'Aumento de Despesas %',
        'projections.availableCash': 'Caixa Dispon√≠vel (R$)',
        'projections.calculate': 'Calcular Cen√°rio',
        
        // Analytics
        'analytics.title': 'An√°lises & Visualiza√ß√µes',
        'analytics.monthlyEvolution': 'Evolu√ß√£o Mensal - Receitas vs Despesas',
        'analytics.revenueDistribution': 'Distribui√ß√£o de Receitas',
        'analytics.expenseDistribution': 'Distribui√ß√£o de Despesas',
        'analytics.marginEvolution': 'Evolu√ß√£o da Margem (%)',
        
        // Reports
        'reports.title': 'Relat√≥rios & Exporta√ß√£o',
        'reports.exportData': 'Exportar Dados',
        'reports.exportCSV': 'Exportar para CSV',
        'reports.backupJSON': 'Backup para JSON',
        'reports.executiveReport': 'Relat√≥rio Executivo',
        
        // Settings
        'settings.title': 'Configura√ß√µes do Sistema',
        'settings.userProfile': 'Perfil do Usu√°rio',
        'settings.authenticatedUser': 'Usu√°rio autenticado',
        'settings.activeSession': 'Sess√£o ativa',
        'settings.transactionsRecorded': 'Transa√ß√µes registradas',
        'settings.advanced': 'Configura√ß√µes Avan√ßadas',
        'settings.comingSoon': 'Em breve: categorias personalizadas, metas autom√°ticas, integra√ß√£o banc√°ria.',
        'settings.databaseStructure': 'Estrutura do Banco de Dados',
        'settings.important': 'Importante:',
        'settings.userIdError': 'Se voc√™ est√° recebendo erros de \'user_id\', use a estrutura SIMPLES abaixo:',
        'settings.simpleStructure': 'Op√ß√£o 1 - Estrutura SIMPLES (recomendado para come√ßar):',
        'settings.completeStructure': 'Op√ß√£o 2 - Estrutura COMPLETA (com isolamento de usu√°rio):',
        'settings.copySimple': 'Copiar Estrutura Simples',
        'settings.copyComplete': 'Copiar Estrutura Completa',
        
        // Chat
        'chat.askData': 'Pergunte aos Dados',
        'chat.title': 'Assistente VitexAI',
        'chat.welcome': 'Ol√°! Posso ajudar voc√™ a analisar seus dados financeiros. Tente perguntar:\n\n‚Ä¢ "Qual foi minha maior despesa este m√™s?"\n‚Ä¢ "Mostre as tend√™ncias de receita"\n‚Ä¢ "Como est√° evoluindo minha margem?"\n‚Ä¢ "Qual √© minha sa√∫de financeira atual?"',
        'chat.send': 'Enviar',
        
        // Footer
        'footer.description': 'Painel de Intelig√™ncia Financeira',
        'footer.version': 'Vers√£o 3.0 | An√°lises Avan√ßadas | Insights em Tempo Real',
        
        // Executive Report
        'report.executiveTitle': 'Relat√≥rio Financeiro Executivo',
        'report.prepared': 'Preparado para',
        'report.board': 'Conselho de Administra√ß√£o',
        'report.executiveSummary': 'Resumo Executivo',
        'report.keyMetrics': 'Indicadores-Chave de Desempenho',
        'report.trendAnalysis': 'An√°lise de Tend√™ncias',
        'report.insights': 'Insights Estrat√©gicos',
        'report.recommendations': 'Recomenda√ß√µes',
        'report.conclusion': 'Conclus√£o',
        'report.details': 'An√°lise Detalhada',
        'report.financialHealth': 'Status de Sa√∫de Financeira',
        'report.growth': 'Crescimento',
        'report.stability': 'Estabilidade',
        'report.decline': 'Decl√≠nio',
        'report.critical': 'Cr√≠tico',
        'report.currentPeriod': 'Per√≠odo Atual',
        'report.previousPeriod': 'Per√≠odo Anterior',
        'report.change': 'Varia√ß√£o',
        'report.positiveGrowth': 'crescimento positivo',
        'report.negativeGrowth': 'decl√≠nio negativo',
        'report.lastUpdated': '√öltima Atualiza√ß√£o',
        'report.printReport': 'Imprimir Relat√≥rio'
    }
};

// Initialize Language System
function initializeLanguageSystem() {
    setLanguage(currentLanguage);
}

// Set language function
function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('vitexai_language', lang);
    
    // Update language selector buttons
    document.querySelectorAll('.language-selector button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === lang.toUpperCase()) {
            btn.classList.add('active');
        }
    });
    
    // Update all text elements
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = translations[lang][key];
        if (translation) {
            element.textContent = translation;
        }
    });
    
    // Update placeholders
    updatePlaceholders();
    
    // Update document language
    document.documentElement.lang = lang === 'pt' ? 'pt-BR' : 'en';
}

// Update placeholders based on language
function updatePlaceholders() {
    const placeholders = {
        en: {
            'loginEmail': 'your@email.com',
            'loginPassword': 'Enter your password',
            'registerName': 'Your full name',
            'registerEmail': 'your@email.com',
            'registerPassword': 'Minimum 8 characters',
            'confirmPassword': 'Re-enter password',
            'quickDescricao': 'Transaction description',
            'chatInput': 'Ask about your data...',
            'metaReceita': 'Ex: 20000',
            'aumentoDespesas': 'Ex: 10',
            'caixaDisponivel': 'Ex: 50000'
        },
        pt: {
            'loginEmail': 'seu@email.com',
            'loginPassword': 'Digite sua senha',
            'registerName': 'Seu nome completo',
            'registerEmail': 'seu@email.com',
            'registerPassword': 'M√≠nimo 8 caracteres',
            'confirmPassword': 'Digite a senha novamente',
            'quickDescricao': 'Descri√ß√£o da transa√ß√£o',
            'chatInput': 'Pergunte sobre seus dados...',
            'metaReceita': 'Ex: 20000',
            'aumentoDespesas': 'Ex: 10',
            'caixaDisponivel': 'Ex: 50000'
        }
    };
    
    Object.keys(placeholders[currentLanguage]).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.placeholder = placeholders[currentLanguage][id];
        }
    });
}

// Function to get translated text
function getTranslation(key) {
    return translations[currentLanguage][key] || key;
}
